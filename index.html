<!DOCTYPE html>
<html>
<head>
  <title>XIAN Trade Totals</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background-color: #111;
      color: #eee;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #444;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #222;
    }
    tr:nth-child(even) {
      background-color: #1a1a1a;
    }
    h1 {
      color: #00f335;
    }
  </style>
</head>
<body>
  <h1>XIAN Trades â€” Totals per Signer</h1>
  <p>From <strong>2025-06-28 00:00</strong> to <strong>2025-07-01 23:59</strong> (Pair 21)</p>

  <table id="results">
    <tr>
      <th>Signer</th>
      <th>Trades</th>
      <th>SSS Sold</th>
      <th>XIAN Sold</th>
      <th>SSS Bought</th>
      <th>XIAN Bought</th>
      <th>Total Volume</th>
    </tr>
  </table>

  <script>
    const query = `
    query {
      allEvents(
        condition: { contract: "con_pairs", event: "Swap" }
        filter: {
          dataIndexed: { contains: { pair: "21" } }
          created: {
            greaterThanOrEqualTo: "2025-06-28T00:00:00"
            lessThanOrEqualTo: "2025-07-01T23:59:59"
          }
        }
        orderBy: CREATED_DESC
        first: 1000
      ) {
        edges {
          node {
            created
            signer
            data
          }
        }
      }
    }`;

    fetch("https://node.xian.org/graphql", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query })
    })
    .then(res => res.json())
    .then(res => {
      const trades = res.data.allEvents.edges.map(edge => edge.node);
      const totals = {};

      trades.forEach(trade => {
        const signer = trade.signer;
        const data = trade.data;
        if (!totals[signer]) {
          totals[signer] = {
            trades: 0,
            sssSold: 0,
            xianSold: 0,
            sssBought: 0,
            xianBought: 0,
            totalVolume: 0
          };
        }

        const parse = v => parseFloat(v || "0");

        totals[signer].trades += 1;
        totals[signer].sssSold   += parse(data.amount0In);
        totals[signer].xianSold  += parse(data.amount1In);
        totals[signer].sssBought += parse(data.amount0Out);
        totals[signer].xianBought+= parse(data.amount1Out);
      });

      // Calculate total volume
      Object.values(totals).forEach(t => {
        t.totalVolume = t.sssSold + t.xianSold + t.sssBought + t.xianBought;
      });

      // Sort by totalVolume descending
      const sorted = Object.entries(totals).sort((a, b) => b[1].totalVolume - a[1].totalVolume);

      const table = document.getElementById("results");
      sorted.forEach(([signer, stats]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${signer}</td>
          <td>${stats.trades}</td>
          <td>${stats.sssSold.toFixed(4)}</td>
          <td>${stats.xianSold.toFixed(4)}</td>
          <td>${stats.sssBought.toFixed(4)}</td>
          <td>${stats.xianBought.toFixed(4)}</td>
          <td>${stats.totalVolume.toFixed(4)}</td>
        `;
        table.appendChild(tr);
      });
    });
  </script>
</body>
</html>
